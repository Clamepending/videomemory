<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Webcam Captioner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1600px;
            width: 100%;
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .instances-container {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .instance {
            flex: 1;
            min-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .instance-header {
            text-align: center;
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .status.disconnected {
            background: #fee;
            color: #c33;
        }

        .status.connected {
            background: #efe;
            color: #3c3;
        }

        .status.captioning {
            background: #eef;
            color: #33c;
        }

        .video-wrapper {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
        }

        video {
            width: 100%;
            height: auto;
            display: block;
        }

        .caption-wrapper {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .caption-container {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .caption-container.empty {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .caption-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .caption-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 0.95em;
            line-height: 1.5;
            color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            animation: slideIn 0.3s ease-out;
            border-left: 3px solid #667eea;
        }

        .caption-item:first-child {
            border-left-color: #4CAF50;
            background: #f0f9f0;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .caption-timestamp {
            font-size: 0.75em;
            color: #999;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .caption-text {
            color: #333;
        }

        .empty-message {
            color: #999;
            font-style: italic;
            text-align: center;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-start {
            background: #4CAF50;
            color: white;
        }

        .btn-start:hover {
            background: #45a049;
        }

        .btn-stop {
            background: #f44336;
            color: white;
        }

        .btn-stop:hover {
            background: #da190b;
        }

        .btn-stop:disabled,
        .btn-start:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .info {
            text-align: center;
            color: #666;
            margin-top: 20px;
            font-size: 0.9em;
        }

        .prompt-section {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .prompt-section h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1em;
        }

        .device-selector {
            margin-bottom: 15px;
            padding: 12px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .device-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .device-select {
            width: 100%;
            padding: 10px;
            font-size: 0.95em;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-family: inherit;
        }

        .device-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .prompt-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .prompt-input {
            flex: 1;
            padding: 12px;
            font-size: 1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }

        .prompt-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-update {
            background: #667eea;
            color: white;
            padding: 12px 20px;
            font-size: 0.95em;
        }

        .btn-update:hover {
            background: #5568d3;
        }

        @media (max-width: 1200px) {
            .instances-container {
                flex-direction: column;
            }

            .instance {
                min-width: 100%;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .prompt-input-wrapper {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• Real-time Webcam Captioner</h1>
        <p class="subtitle">AI-powered live captioning from your webcam</p>
        
        <div class="instances-container">
            <!-- Instance 1 -->
            <div class="instance" id="instance1">
                <div class="instance-header">Instance 1</div>
                
                <!-- Device Selector -->
                <div class="device-selector">
                    <label for="deviceSelect1">üìπ Camera:</label>
                    <select id="deviceSelect1" class="device-select">
                        <option value="">Loading devices...</option>
                    </select>
                </div>
                
                <!-- Video Feed -->
                <div class="video-wrapper">
                    <video id="video1" autoplay playsinline></video>
                </div>
                
                <!-- Prompt Section -->
                <div class="prompt-section">
                    <h3>üìù Caption Prompt:</h3>
                    <div class="prompt-input-wrapper">
                        <textarea 
                            id="promptInput1" 
                            class="prompt-input" 
                            placeholder="Describe this image in 2 sentences."
                            rows="2"
                        >Describe this image in 2 sentences.</textarea>
                        <button id="updatePromptBtn1" class="btn-update" onclick="updatePrompt('1')">
                            Update Prompt
                        </button>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="controls">
                    <button id="startBtn1" class="btn-start" onclick="startCaptioning('1')">
                        ‚ñ∂ Start Captioning
                    </button>
                    <button id="stopBtn1" class="btn-stop" onclick="stopCaptioning('1')" disabled>
                        ‚èπ Stop Captioning
                    </button>
                </div>
                
                <!-- Caption Queue -->
                <div class="caption-wrapper">
                    <h3 style="margin-bottom: 10px; color: #333;">Captions:</h3>
                    <div id="captionContainer1" class="caption-container empty">
                        <div class="empty-message">No captions yet. Start captioning to see results.</div>
                    </div>
                </div>
            </div>

            <!-- Instance 2 -->
            <div class="instance" id="instance2">
                <div class="instance-header">Instance 2</div>
                
                <!-- Device Selector -->
                <div class="device-selector">
                    <label for="deviceSelect2">üìπ Camera:</label>
                    <select id="deviceSelect2" class="device-select">
                        <option value="">Loading devices...</option>
                    </select>
                </div>
                
                <!-- Video Feed -->
                <div class="video-wrapper">
                    <video id="video2" autoplay playsinline></video>
                </div>
                
                <!-- Prompt Section -->
                <div class="prompt-section">
                    <h3>üìù Caption Prompt:</h3>
                    <div class="prompt-input-wrapper">
                        <textarea 
                            id="promptInput2" 
                            class="prompt-input" 
                            placeholder="Describe this image in 2 sentences."
                            rows="2"
                        >Describe this image in 2 sentences.</textarea>
                        <button id="updatePromptBtn2" class="btn-update" onclick="updatePrompt('2')">
                            Update Prompt
                        </button>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="controls">
                    <button id="startBtn2" class="btn-start" onclick="startCaptioning('2')">
                        ‚ñ∂ Start Captioning
                    </button>
                    <button id="stopBtn2" class="btn-stop" onclick="stopCaptioning('2')" disabled>
                        ‚èπ Stop Captioning
                    </button>
                </div>
                
                <!-- Caption Queue -->
                <div class="caption-wrapper">
                    <h3 style="margin-bottom: 10px; color: #333;">Captions:</h3>
                    <div id="captionContainer2" class="caption-container empty">
                        <div class="empty-message">No captions yet. Start captioning to see results.</div>
                    </div>
                </div>
            </div>
        </div>

        <p class="info">
            Frames are captured every 2 seconds and sent to the AI model for captioning.
        </p>
    </div>

    <script>
        const MAX_CAPTIONS = 50; // Maximum number of captions to keep

        // Instance manager class
        class CaptionerInstance {
            constructor(id) {
                this.id = id;
                this.video = document.getElementById(`video${id}`);
                this.captionContainer = document.getElementById(`captionContainer${id}`);
                this.startBtn = document.getElementById(`startBtn${id}`);
                this.stopBtn = document.getElementById(`stopBtn${id}`);
                this.promptInput = document.getElementById(`promptInput${id}`);
                this.updatePromptBtn = document.getElementById(`updatePromptBtn${id}`);
                this.deviceSelect = document.getElementById(`deviceSelect${id}`);
                
                this.stream = null;
                this.websocket = null;
                this.captureInterval = null;
                this.canvas = document.createElement('canvas');
                this.currentPrompt = "Describe this image in 2 sentences.";
                this.captionCount = 0;
                this.availableDevices = [];
                this.pendingCaption = false; // Track if a caption request is in progress
                this.captureTimeout = null; // Track the timeout for next capture
            }

            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/captioning`;
                
                this.websocket = new WebSocket(wsUrl);
                
                this.websocket.onopen = () => {
                    console.log(`Instance ${this.id}: WebSocket connected`);
                };
                
                this.websocket.onmessage = (event) => {
                    const data = event.data;
                    
                    // Try to parse as JSON (for prompt updates)
                    try {
                        const message = JSON.parse(data);
                        if (message.type === 'prompt_updated') {
                            this.currentPrompt = message.prompt;
                            this.promptInput.value = this.currentPrompt;
                            return;
                        }
                    } catch (e) {
                        // Not JSON, treat as caption text
                    }
                    
                    // Display caption
                    this.displayCaption(data);
                    
                    // Mark caption as received, ready for next frame
                    this.pendingCaption = false;
                    
                    // Schedule next capture after receiving this caption
                    this.scheduleNextCapture();
                };
                
                this.websocket.onerror = (error) => {
                    console.error(`Instance ${this.id}: WebSocket error:`, error);
                };
                
                this.websocket.onclose = () => {
                    console.log(`Instance ${this.id}: WebSocket disconnected`);
                };
            }

            displayCaption(text) {
                // Remove empty message if present
                if (this.captionContainer.classList.contains('empty')) {
                    this.captionContainer.innerHTML = '';
                    this.captionContainer.classList.remove('empty');
                }
                
                // Create caption list if it doesn't exist
                let captionList = this.captionContainer.querySelector('.caption-list');
                if (!captionList) {
                    captionList = document.createElement('div');
                    captionList.className = 'caption-list';
                    this.captionContainer.appendChild(captionList);
                }
                
                // Create new caption item
                const captionItem = document.createElement('div');
                captionItem.className = 'caption-item';
                
                // Add timestamp
                const timestamp = document.createElement('div');
                timestamp.className = 'caption-timestamp';
                const now = new Date();
                const timeStr = now.toLocaleTimeString();
                timestamp.textContent = timeStr;
                
                // Add caption text
                const captionText = document.createElement('div');
                captionText.className = 'caption-text';
                captionText.textContent = text;
                
                captionItem.appendChild(timestamp);
                captionItem.appendChild(captionText);
                
                // Insert at the top of the list
                captionList.insertBefore(captionItem, captionList.firstChild);
                
                // Limit the number of captions to prevent memory issues
                this.captionCount++;
                const items = captionList.querySelectorAll('.caption-item');
                if (items.length > MAX_CAPTIONS) {
                    items[items.length - 1].remove();
                }
            }

            async startCaptioning() {
                try {
                    // Get selected device ID
                    const deviceId = this.deviceSelect.value;
                    
                    // Build video constraints
                    const videoConstraints = {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    };
                    
                    // Use selected device if available
                    if (deviceId) {
                        videoConstraints.deviceId = { exact: deviceId };
                    } else {
                        // Fallback to default (facingMode for front camera)
                        videoConstraints.facingMode = 'user';
                    }
                    
                    // Request webcam access
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: videoConstraints
                    });
                    
                    this.video.srcObject = this.stream;
                    await this.video.play();
                    
                    // Connect WebSocket
                    this.connectWebSocket();
                    
                    // Wait for WebSocket to be ready
                    await new Promise((resolve) => {
                        if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                            resolve();
                        } else {
                            this.websocket.addEventListener('open', resolve, { once: true });
                        }
                    });
                    
                    // Send initial prompt
                    if (this.promptInput.value.trim()) {
                        this.websocket.send(JSON.stringify({
                            type: 'prompt',
                            prompt: this.promptInput.value.trim()
                        }));
                        this.currentPrompt = this.promptInput.value.trim();
                    }
                    
                    // Wait for video to be ready and set up canvas dimensions
                    await new Promise((resolve) => {
                        const checkVideo = () => {
                            if (this.video.videoWidth > 0 && this.video.videoHeight > 0) {
                                this.canvas.width = this.video.videoWidth;
                                this.canvas.height = this.video.videoHeight;
                                console.log(`Instance ${this.id}: Canvas initialized: ${this.canvas.width}x${this.canvas.height}`);
                                resolve();
                            } else {
                                setTimeout(checkVideo, 100);
                            }
                        };
                        checkVideo();
                    });
                    
                    // Start capturing frames (first frame after a short delay)
                    // Subsequent frames will be scheduled after each caption is received
                    this.pendingCaption = false;
                    setTimeout(() => this.captureAndSendFrame(), 1000);
                    
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    this.deviceSelect.disabled = true;
                    
                } catch (error) {
                    console.error(`Instance ${this.id}: Error starting captioning:`, error);
                    alert(`Error accessing webcam: ${error.message}`);
                }
            }

            stopCaptioning() {
                // Stop frame capture
                if (this.captureInterval) {
                    clearInterval(this.captureInterval);
                    this.captureInterval = null;
                }
                
                // Clear any pending capture timeout
                if (this.captureTimeout) {
                    clearTimeout(this.captureTimeout);
                    this.captureTimeout = null;
                }
                
                // Stop webcam stream
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                // Close WebSocket
                if (this.websocket) {
                    this.websocket.close();
                    this.websocket = null;
                }
                
                // Clear video
                this.video.srcObject = null;
                
                // Reset UI and state
                this.captionContainer.innerHTML = '<div class="empty-message">No captions yet. Start captioning to see results.</div>';
                this.captionContainer.classList.add('empty');
                this.captionCount = 0;
                this.pendingCaption = false;
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                this.deviceSelect.disabled = false;
            }
            
            scheduleNextCapture() {
                // Only schedule if captioning is active and no request is pending
                if (this.pendingCaption || !this.stream || !this.websocket || this.websocket.readyState !== WebSocket.OPEN) {
                    return;
                }
                
                // Schedule next capture after 2 seconds (or minimum interval)
                this.captureTimeout = setTimeout(() => {
                    this.captureAndSendFrame();
                }, 2000); // 2 seconds between captures
            }

            captureAndSendFrame() {
                // Don't send if a request is already pending
                if (this.pendingCaption) {
                    console.log(`Instance ${this.id}: Skipping capture - previous request still pending`);
                    return;
                }
                
                if (!this.video || !this.websocket || this.websocket.readyState !== WebSocket.OPEN) {
                    console.log(`Instance ${this.id}: Cannot capture: video or websocket not ready`);
                    return;
                }
                
                // Check if video is ready
                if (this.video.readyState !== this.video.HAVE_ENOUGH_DATA) {
                    console.log(`Instance ${this.id}: Video not ready, skipping frame`);
                    // Retry after a short delay
                    this.captureTimeout = setTimeout(() => this.captureAndSendFrame(), 500);
                    return;
                }
                
                // Ensure canvas dimensions match video
                if (this.canvas.width !== this.video.videoWidth || this.canvas.height !== this.video.videoHeight) {
                    this.canvas.width = this.video.videoWidth || 640;
                    this.canvas.height = this.video.videoHeight || 480;
                    console.log(`Instance ${this.id}: Canvas resized to ${this.canvas.width}x${this.canvas.height}`);
                }
                
                // Check for valid dimensions
                if (this.canvas.width === 0 || this.canvas.height === 0) {
                    console.log(`Instance ${this.id}: Invalid canvas dimensions, skipping frame`);
                    // Retry after a short delay
                    this.captureTimeout = setTimeout(() => this.captureAndSendFrame(), 500);
                    return;
                }
                
                try {
                    // Draw video frame to canvas
                    const ctx = this.canvas.getContext('2d');
                    ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    
                    // Convert canvas to base64 JPEG
                    const imageData = this.canvas.toDataURL('image/jpeg', 0.85);
                    
                    if (!imageData || imageData.length < 100) {
                        console.error(`Instance ${this.id}: Invalid image data generated`);
                        return;
                    }
                    
                    // Mark that we have a pending caption request
                    this.pendingCaption = true;
                    
                    // Send to server via WebSocket as JSON
                    this.websocket.send(JSON.stringify({
                        type: 'frame',
                        data: imageData
                    }));
                    
                    console.log(`Instance ${this.id}: Frame sent, waiting for caption...`);
                    
                } catch (error) {
                    console.error(`Instance ${this.id}: Error capturing frame:`, error);
                    this.pendingCaption = false; // Reset on error
                }
            }

            updatePrompt() {
                const newPrompt = this.promptInput.value.trim();
                if (!newPrompt) {
                    alert('Please enter a prompt');
                    return;
                }
                
                if (!this.websocket || this.websocket.readyState !== WebSocket.OPEN) {
                    alert('Not connected. Please start captioning first.');
                    return;
                }
                
                // Send prompt update as JSON
                this.websocket.send(JSON.stringify({
                    type: 'prompt',
                    prompt: newPrompt
                }));
                
                this.currentPrompt = newPrompt;
                this.updatePromptBtn.disabled = true;
                this.updatePromptBtn.textContent = 'Updating...';
                
                // Re-enable button after a moment
                setTimeout(() => {
                    this.updatePromptBtn.disabled = false;
                    this.updatePromptBtn.textContent = 'Update Prompt';
                }, 1000);
            }
        }

        // Function to enumerate and populate device selectors
        async function enumerateDevices() {
            try {
                // First request permission to access devices (required for device labels)
                await navigator.mediaDevices.getUserMedia({ video: true });
                
                // Enumerate all devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                
                // Filter video input devices
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                // Populate both device selectors
                instance1.populateDeviceSelector(videoDevices);
                instance2.populateDeviceSelector(videoDevices);
                
                console.log(`Found ${videoDevices.length} video device(s)`);
            } catch (error) {
                console.error('Error enumerating devices:', error);
                // Still populate with default option
                instance1.deviceSelect.innerHTML = '<option value="">Default Camera</option>';
                instance2.deviceSelect.innerHTML = '<option value="">Default Camera</option>';
            }
        }

        // Add method to populate device selector
        CaptionerInstance.prototype.populateDeviceSelector = function(devices) {
            this.deviceSelect.innerHTML = '<option value="">Default Camera</option>';
            
            devices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                // Use label if available, otherwise use a generic name
                option.textContent = device.label || `Camera ${index + 1}`;
                this.deviceSelect.appendChild(option);
            });
            
            this.availableDevices = devices;
        };

        // Initialize instances
        const instance1 = new CaptionerInstance('1');
        const instance2 = new CaptionerInstance('2');
        
        // Enumerate devices on page load
        window.addEventListener('load', () => {
            enumerateDevices();
        });

        // Global functions for onclick handlers
        function startCaptioning(id) {
            if (id === '1') {
                instance1.startCaptioning();
            } else if (id === '2') {
                instance2.startCaptioning();
            }
        }

        function stopCaptioning(id) {
            if (id === '1') {
                instance1.stopCaptioning();
            } else if (id === '2') {
                instance2.stopCaptioning();
            }
        }

        function updatePrompt(id) {
            if (id === '1') {
                instance1.updatePrompt();
            } else if (id === '2') {
                instance2.updatePrompt();
            }
        }

        // Allow Enter key to update prompt (Ctrl+Enter or Cmd+Enter)
        instance1.promptInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                instance1.updatePrompt();
            }
        });

        instance2.promptInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                instance2.updatePrompt();
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            instance1.stopCaptioning();
            instance2.stopCaptioning();
        });
    </script>
</body>
</html>

