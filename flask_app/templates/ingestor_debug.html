{% extends "base.html" %}

{% block title %}Ingestor Debug - VideoMemory{% endblock %}

{% block extra_styles %}
        .debug-container {
            width: 100%;
            max-width: 1400px;
            padding: 30px 20px;
            height: 100%;
            overflow-y: auto;
        }

        .debug-header {
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-button {
            padding: 8px 16px;
            background: #404040;
            color: #ececec;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: #505050;
        }

        .debug-header h1 {
            font-size: 24px;
            font-weight: 500;
            color: #ececec;
            flex: 1;
        }

        .debug-status-badge {
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .debug-status-badge.running {
            background: #19c37d;
            color: white;
        }

        .debug-status-badge.stopped {
            background: #666;
            color: #ececec;
        }

        .debug-status-badge.no-ingestor {
            background: #555;
            color: #999;
        }

        .debug-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .debug-panel {
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 20px;
        }

        .debug-panel.full-width {
            grid-column: 1 / -1;
        }

        .debug-panel h2 {
            font-size: 16px;
            font-weight: 500;
            color: #19c37d;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #404040;
        }

        #currentFrame {
            max-width: 100%;
            border: 2px solid #404040;
            border-radius: 8px;
            display: block;
            margin: 10px 0;
        }

        .frame-timestamp {
            font-size: 11px;
            color: #666;
            margin-top: 6px;
        }

        .prompt-pre {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            color: #b0b0b0;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            border: 1px solid #333;
        }

        .task-item {
            background: #1a1a1a;
            border-left: 3px solid #19c37d;
            padding: 12px;
            margin: 8px 0;
            border-radius: 0 6px 6px 0;
        }

        .task-item.done {
            border-left-color: #666;
            opacity: 0.7;
        }

        .task-item strong {
            color: #ececec;
            font-size: 13px;
        }

        .task-item .task-done-badge {
            font-size: 11px;
            color: #888;
            margin-left: 6px;
        }

        .task-item .task-note {
            margin-top: 6px;
            padding-left: 10px;
            border-left: 2px solid #19c37d;
            font-size: 13px;
            color: #b0b0b0;
        }

        .task-item .task-note .note-ts {
            font-size: 11px;
            color: #555;
        }

        .task-item .no-notes {
            margin-top: 6px;
            padding-left: 10px;
            font-size: 13px;
            color: #555;
            font-style: italic;
        }

        .history-entry {
            background: #1a1a1a;
            border-left: 3px solid #888;
            padding: 10px;
            margin: 6px 0;
            border-radius: 0 6px 6px 0;
            font-size: 12px;
            color: #b0b0b0;
        }

        .history-entry strong {
            color: #ececec;
        }

        .no-data {
            color: #666;
            font-style: italic;
            font-size: 13px;
        }

        .no-ingestor-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .no-ingestor-state h2 {
            color: #666;
            font-size: 22px;
            margin-bottom: 10px;
            border: none;
            padding: 0;
        }

        .no-ingestor-state p {
            font-size: 14px;
        }

        @media (max-width: 900px) {
            .debug-grid {
                grid-template-columns: 1fr;
            }
            .debug-panel.full-width {
                grid-column: 1;
            }
        }
{% endblock %}

{% block content %}
    <div class="debug-container">
        <div class="debug-header">
            <a href="/devices" class="back-button">&larr; Back to Devices</a>
            <h1 id="debugTitle">Ingestor Debug</h1>
            <span class="debug-status-badge no-ingestor" id="statusBadge">Loading...</span>
        </div>
        <div id="debugContent">
            <div class="no-data">Checking ingestor status...</div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
        const IO_ID = '{{ io_id }}';
        let deviceName = IO_ID;

        async function fetchDeviceName() {
            try {
                const resp = await fetch('/api/devices');
                const data = await resp.json();
                const devices = data.devices || {};
                for (const category of Object.values(devices)) {
                    for (const dev of category) {
                        if (dev.io_id === IO_ID) {
                            deviceName = dev.name;
                            document.getElementById('debugTitle').textContent = `Debug â€” ${deviceName}`;
                            return;
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to fetch device name', e);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function checkStatus() {
            try {
                const resp = await fetch(`/api/device/${IO_ID}/debug/status`);
                const data = await resp.json();
                const badge = document.getElementById('statusBadge');
                if (data.running) {
                    badge.textContent = 'Running';
                    badge.className = 'debug-status-badge running';
                    return true;
                } else if (data.has_ingestor) {
                    badge.textContent = 'Stopped';
                    badge.className = 'debug-status-badge stopped';
                    return true;
                } else {
                    badge.textContent = 'No Ingestor';
                    badge.className = 'debug-status-badge no-ingestor';
                    return false;
                }
            } catch (e) {
                return false;
            }
        }

        function renderNoIngestor() {
            document.getElementById('debugContent').innerHTML = `
                <div class="no-ingestor-state">
                    <h2>No active ingestor</h2>
                    <p>No tasks are currently running on this device. Create a task for this device to start the ingestor.</p>
                </div>
            `;
        }

        function renderDebugPanels() {
            document.getElementById('debugContent').innerHTML = `
                <div class="debug-grid">
                    <div class="debug-panel full-width">
                        <h2>Current Frame</h2>
                        <img id="currentFrame" alt="Current frame" />
                        <div class="frame-timestamp" id="frameTimestamp"></div>
                    </div>
                    <div class="debug-panel">
                        <h2>Ingestor Tasks</h2>
                        <div id="tasksList"><span class="no-data">Loading tasks...</span></div>
                    </div>
                    <div class="debug-panel">
                        <h2>Output History <span id="historyCount" style="color:#888; font-weight:normal;"></span></h2>
                        <div id="historyList"><span class="no-data">Loading history...</span></div>
                    </div>
                    <div class="debug-panel full-width">
                        <h2>Current Prompt</h2>
                        <pre class="prompt-pre" id="promptContent">Loading...</pre>
                    </div>
                </div>
            `;
        }

        async function updateFrame() {
            try {
                const resp = await fetch(`/api/device/${IO_ID}/debug/frame-and-prompt`);
                const data = await resp.json();
                const img = document.getElementById('currentFrame');
                const ts = document.getElementById('frameTimestamp');
                const prompt = document.getElementById('promptContent');
                if (!img) return;

                if (data.frame_base64) {
                    img.src = 'data:image/jpeg;base64,' + data.frame_base64;
                    ts.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
                } else {
                    img.src = '';
                    ts.textContent = data.error || 'No frame available';
                }
                if (data.prompt) {
                    prompt.textContent = data.prompt;
                } else {
                    prompt.textContent = 'No prompt available yet...';
                }
            } catch (e) {
                console.error('Error fetching frame:', e);
            }
        }

        async function updateTasks() {
            try {
                const resp = await fetch(`/api/device/${IO_ID}/debug/tasks`);
                const data = await resp.json();
                const container = document.getElementById('tasksList');
                if (!container) return;

                const tasks = data.tasks || [];
                if (tasks.length === 0) {
                    container.innerHTML = '<span class="no-data">No tasks on this ingestor.</span>';
                    return;
                }
                let html = '';
                tasks.forEach(task => {
                    const doneClass = task.done ? ' done' : '';
                    html += `<div class="task-item${doneClass}">`;
                    html += `<strong>Task ${escapeHtml(String(task.task_number ?? task.task_id))}:</strong> ${escapeHtml(task.task_desc)}`;
                    html += `<span class="task-done-badge">(${task.done ? 'Done' : 'Active'})</span>`;
                    if (task.latest_note) {
                        html += `<div class="task-note">${escapeHtml(task.latest_note.content)} <span class="note-ts">(${task.latest_note.timestamp || ''})</span></div>`;
                    } else {
                        html += `<div class="no-notes">No notes yet</div>`;
                    }
                    html += '</div>';
                });
                container.innerHTML = html;
            } catch (e) {
                console.error('Error fetching tasks:', e);
            }
        }

        async function updateHistory() {
            try {
                const resp = await fetch(`/api/device/${IO_ID}/debug/history`);
                const data = await resp.json();
                const container = document.getElementById('historyList');
                const countSpan = document.getElementById('historyCount');
                if (!container) return;

                const history = data.history || [];
                const totalCount = data.total_count || history.length;
                if (countSpan) countSpan.textContent = `(${totalCount} total)`;

                if (history.length === 0) {
                    container.innerHTML = '<span class="no-data">No output history yet...</span>';
                    return;
                }

                let html = '';
                for (let i = history.length - 1; i >= 0; i--) {
                    const output = history[i];
                    const outputNumber = totalCount - (history.length - 1 - i);
                    html += '<div class="history-entry">';
                    html += `<strong>Output #${outputNumber}</strong><br>`;
                    if (output.task_updates && output.task_updates.length > 0) {
                        output.task_updates.forEach(u => {
                            html += `Task ${u.task_number}: ${escapeHtml(u.task_note || '')}<br>`;
                        });
                    }
                    if (output.system_actions && output.system_actions.length > 0) {
                        output.system_actions.forEach(a => {
                            html += `Action: ${escapeHtml(a.take_action || '')}<br>`;
                        });
                    }
                    if ((!output.task_updates || output.task_updates.length === 0) &&
                        (!output.system_actions || output.system_actions.length === 0)) {
                        html += '<span class="no-data">No updates</span>';
                    }
                    html += '</div>';
                }
                container.innerHTML = html;
            } catch (e) {
                console.error('Error fetching history:', e);
            }
        }

        let panelsRendered = false;

        async function tick() {
            const hasIngestor = await checkStatus();
            if (!hasIngestor) {
                if (panelsRendered) { panelsRendered = false; }
                renderNoIngestor();
                return;
            }
            if (!panelsRendered) {
                renderDebugPanels();
                panelsRendered = true;
            }
            updateFrame();
            updateTasks();
            updateHistory();
        }

        // Init
        fetchDeviceName();
        tick();
        setInterval(tick, 1000);
    </script>
{% endblock %}
